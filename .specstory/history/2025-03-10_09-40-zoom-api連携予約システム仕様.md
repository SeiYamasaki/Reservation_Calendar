## SpecStory

## Zoom API連携予約システム仕様 (2025/3/10 9:40:58)

_**User**_

【システム仕様まとめ】

### システム概要
Laravelで、Zoom APIと連携したオンラインMT（ミーティング）予約システムを構築する。

## システム要件

### 1. カレンダー機能（実装済み）
- ユーザーはカレンダーから日付と時間枠を選択できる。
- 現在の日時より未来の日時のみ予約可能。
- 時間枠は選択した開始時間から30分間とする。

### 2. Zoom API連携
- 選択した時間枠から自動的に30分間のZoom MTを予約する。

### 3. データベース設計
以下の情報を管理するテーブルを作成する。

| カラム名（仮） | 説明                         |
|---------------|------------------------------|
| id            | 予約ID（主キー）              |
| host_user_id  | Zoomミーティングの主催者情報（予約者）|
| participant_email | Zoomミーティング参加者のメールアドレス |
| start_time    | ミーティング開始日時           |
| end_time      | ミーティング終了日時（開始から30分後）|
| waiting_room  | Zoomミーティングの受付のオンオフ |
| max_participants | 参加人数の制限               |
| created_at    | 作成日時                      |
| updated_at    | 更新日時                      |

※必要に応じてユーザーテーブルや他の情報（名前・メールアドレス等）を追加

### 4. ビューの作成
- カレンダーとは別に「予約一覧」として予約状況を確認するビューを作成。
  - 予約の詳細表示（日時、主催者、参加者、受付状況、参加人数制限）

### 5. 予約フロー
1. ユーザーがカレンダー上で日付と時間（未来の時間のみ）を選択。
2. 選択された時間を起点に30分間のZoom MT枠をZoom APIを通じて自動予約。
3. 予約情報がDBに保存される。
4. 別途用意したビューに予約情報が表示される。

### 6. Zoom APIキー設定（環境変数）
Zoom APIキーは環境変数として`.env`ファイルで管理する。

```
ZOOM_API_KEY=your_zoom_api_key
ZOOM_API_SECRET=your_zoom_api_secret
ZOOM_API_URL=https://api.zoom.us/v2/
```

### 7. 使用技術
- フレームワーク: Laravel
- データベース: MariaDB
- 外部API: Zoom API

---

以上の仕様を元に、Zoom連携予約システムの開発を進める。



---

_**Assistant**_

<think>このリクエストでは、LaravelでZoom APIと連携したオンラインミーティング予約システムの開発についての仕様が日本語で示されています。まず現在のプロジェクト状況を確認し、必要なファイルを探索して、ZoomとLaravelを連携させるための実装を進めていきます。

まずはプロジェクトの構造を確認してみましょう。</think>まずプロジェクトの構造を確認して、現状を把握しましょう。

---

_****_

<details>
            <summary>Listed current directory • **29** results</summary>
        
| Name |
|-------|
| 📁 `app` |
| 📁 `.git` |
| 📁 `routes` |
| 📁 `.specstory` |
| 📁 `public` |
| 📁 `node_modules` |
| 📄 `package-lock.json` |
| 📄 `.env` |
| 📁 `vendor` |
| 📁 `tests` |
| 📄 `vite.config.js` |
| 📁 `storage` |
| 📄 `tailwind.config.js` |
| 📁 `resources` |
| 📄 `package.json` |
| 📄 `phpunit.xml` |
| 📄 `postcss.config.js` |
| 📁 `database` |
| 📄 `docker-compose.yml` |
| 📁 `config` |
| 📄 `composer.lock` |
| 📄 `artisan` |
| 📁 `bootstrap` |
| 📄 `composer.json` |
| 📄 `.editorconfig` |
| 📄 `.env.example` |
| 📄 `.gitattributes` |
| 📄 `.gitignore` |
| 📄 `README.md` |

</details>

---

_****_

次に、すでに実装されているカレンダー機能を確認しましょう。ルーティングから確認します。

---

_****_

Read file: undefined

---

_****_

コントローラを確認しましょう。

---

_****_

Read file: undefined

---

_****_

Read file: undefined

---

_****_

モデルの構造も確認しましょう。

---

_****_

Read file: undefined

---

_****_

現在のマイグレーションファイルを確認しましょう。

---

_****_

<details>
            <summary>Grep search for "create_bookings_table" • **0** files</summary>
        
No results found
</details>

---

_****_

<details>
            <summary>Listed directory database/migrations • **4** results</summary>
        
| Name |
|-------|
| 📄 `0001_01_01_000001_create_cache_table.php` |
| 📄 `0001_01_01_000002_create_jobs_table.php` |
| 📄 `2025_03_05_023924_create_bookings_table.php` |
| 📄 `0001_01_01_000000_create_users_table.php` |

</details>

---

_****_

Read file: undefined

---

_****_

ビューファイルも確認しましょう。

---

_****_

Read file: undefined

---

_****_

ここまでの確認から以下が明らかになりました：

1. すでに基本的な予約システムは実装されており、カレンダーから予約を作成・削除できる
2. 現在のBookingモデルは基本的なフィールド（title, start, end）のみを持つ
3. Zoom APIとの連携はまだ実装されていない

これから実装する必要があるのは：

1. Bookingモデルの拡張（Zoom関連フィールドの追加）
2. Zoom API連携の実装
3. 予約一覧ビューの作成

まず、マイグレーションファイルを作成して必要なテーブル構造を実装しましょう。

---

_****_

```bash
php artisan make:migration update_bookings_table_for_zoom_integration --table=bookings
```

```

   INFO  Migration [database/migrations/2025_03_10_005510_update_bookings_table_
for_zoom_integration.php] cr
eated successfully.
                            

```

---

_****_

次に、マイグレーションファイルを編集して必要なカラムを追加します。

---

_****_

Read file: undefined

---

_****_

マイグレーションファイルを編集して必要なカラムを追加します。

---

_****_

```diff
      {
          Schema::table('bookings', function (Blueprint $table) {
-             //
+             $table->string('host_user_id')->nullable()->after('title');
+             $table->string('participant_email')->nullable()->after('host_user_id');
+             $table->string('zoom_meeting_id')->nullable()->after('end');
+             $table->string('zoom_meeting_url')->nullable()->after('zoom_meeting_id');
+             $table->string('zoom_meeting_password')->nullable()->after('zoom_meeting_url');
+             $table->boolean('waiting_room')->default(true)->after('zoom_meeting_password');
+             $table->integer('max_participants')->default(10)->after('waiting_room');
          });
      }
      {
          Schema::table('bookings', function (Blueprint $table) {
-             //
+             $table->dropColumn([
+                 'host_user_id', 
+                 'participant_email',
+                 'zoom_meeting_id',
+                 'zoom_meeting_url',
+                 'zoom_meeting_password',
+                 'waiting_room',
+                 'max_participants'
+             ]);
          });
      }
```

---

_****_

次に、Bookingモデルを更新して新しいカラムを使えるようにします。

---

_****_

```diff
      use HasFactory;
  
-     protected $fillable = ['title', 'start', 'end'];
+     protected $fillable = [
+         'title', 
+         'start', 
+         'end',
+         'host_user_id',
+         'participant_email',
+         'zoom_meeting_id',
+         'zoom_meeting_url',
+         'zoom_meeting_password',
+         'waiting_room',
+         'max_participants'
+     ];
  }
  
```

---

_****_

マイグレーションを実行します。

---

_****_

```bash
php artisan migrate
```

```
$ sail artisan migrate

   INFO  Running migrations.  

  2025_03_10_005510_update_bookings_table_for_zoom_integration .............................. 21.91ms DONE

iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

次に、Zoom APIとの連携を実装するためのサービスクラスを作成します。

---

_****_

```bash
mkdir -p app/Services
```

```
$ mkdir -p app/Services
iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

Zoom API連携用のサービスクラスを作成します。

---

_****_

```diff
- 
+ <?php
+ 
+ namespace App\Services;
+ 
+ use Illuminate\Support\Facades\Http;
+ use Illuminate\Support\Facades\Log;
+ 
+ class ZoomService
+ {
+     protected $apiKey;
+     protected $apiSecret;
+     protected $apiUrl;
+     protected $jwt;
+ 
+     public function __construct()
+     {
+         $this->apiKey = config('services.zoom.api_key');
+         $this->apiSecret = config('services.zoom.api_secret');
+         $this->apiUrl = config('services.zoom.api_url');
+         $this->jwt = $this->generateJWT();
+     }
+ 
+     /**
+      * Zoom JWT トークンを生成する
+      */
+     protected function generateJWT()
+     {
+         $key = $this->apiKey;
+         $secret = $this->apiSecret;
+         
+         $token = [
+             'iss' => $key,
+             'exp' => time() + 60 * 60, // 1時間の有効期限
+         ];
+         
+         // JWTライブラリを使用してトークンを生成
+         $jwt = \Firebase\JWT\JWT::encode($token, $secret, 'HS256');
+         
+         return $jwt;
+     }
+ 
+     /**
+      * Zoomミーティングを作成する
+      * 
+      * @param array $data
+      * @return mixed
+      */
+     public function createMeeting(array $data)
+     {
+         try {
+             $response = Http::withHeaders([
+                 'Authorization' => 'Bearer ' . $this->jwt,
+                 'Content-Type' => 'application/json',
+             ])->post($this->apiUrl . 'users/me/meetings', [
+                 'topic' => $data['title'] ?? 'オンラインミーティング',
+                 'type' => 2, // スケジュールされたミーティング
+                 'start_time' => date('Y-m-d\TH:i:s', strtotime($data['start'])),
+                 'duration' => 30, // 30分間
+                 'timezone' => 'Asia/Tokyo',
+                 'settings' => [
+                     'host_video' => true,
+                     'participant_video' => true,
+                     'waiting_room' => $data['waiting_room'] ?? true,
+                     'join_before_host' => false,
+                     'mute_upon_entry' => true,
+                     'watermark' => false,
+                     'approval_type' => 0,
+                     'registration_type' => 1,
+                     'audio' => 'both',
+                     'auto_recording' => 'none',
+                 ]
+             ]);
+ 
+             if ($response->successful()) {
+                 Log::info('Zoom会議が正常に作成されました。', [
+                     'meeting_id' => $response->json('id'),
+                     'join_url' => $response->json('join_url')
+                 ]);
+                 return $response->json();
+             } else {
+                 Log::error('Zoom会議の作成中にエラーが発生しました。', [
+                     'status' => $response->status(),
+                     'response' => $response->json()
+                 ]);
+                 return false;
+             }
+         } catch (\Exception $e) {
+             Log::error('Zoom API呼び出し中に例外が発生しました。', [
+                 'message' => $e->getMessage(),
+                 'trace' => $e->getTraceAsString()
+             ]);
+             return false;
+         }
+     }
+ 
+     /**
+      * Zoom会議の詳細を取得する
+      * 
+      * @param string $meetingId
+      * @return mixed
+      */
+     public function getMeeting($meetingId)
+     {
+         try {
+             $response = Http::withHeaders([
+                 'Authorization' => 'Bearer ' . $this->jwt,
+                 'Content-Type' => 'application/json',
+             ])->get($this->apiUrl . 'meetings/' . $meetingId);
+ 
+             if ($response->successful()) {
+                 return $response->json();
+             } else {
+                 Log::error('Zoom会議の詳細取得中にエラーが発生しました。', [
+                     'meeting_id' => $meetingId,
+                     'status' => $response->status(),
+                     'response' => $response->json()
+                 ]);
+                 return false;
+             }
+         } catch (\Exception $e) {
+             Log::error('Zoom API呼び出し中に例外が発生しました。', [
+                 'message' => $e->getMessage(),
+                 'trace' => $e->getTraceAsString()
+             ]);
+             return false;
+         }
+     }
+ 
+     /**
+      * Zoom会議を削除する
+      * 
+      * @param string $meetingId
+      * @return mixed
+      */
+     public function deleteMeeting($meetingId)
+     {
+         try {
+             $response = Http::withHeaders([
+                 'Authorization' => 'Bearer ' . $this->jwt,
+                 'Content-Type' => 'application/json',
+             ])->delete($this->apiUrl . 'meetings/' . $meetingId);
+ 
+             if ($response->successful()) {
+                 Log::info('Zoom会議が正常に削除されました。', [
+                     'meeting_id' => $meetingId
+                 ]);
+                 return true;
+             } else {
+                 Log::error('Zoom会議の削除中にエラーが発生しました。', [
+                     'meeting_id' => $meetingId,
+                     'status' => $response->status(),
+                     'response' => $response->json()
+                 ]);
+                 return false;
+             }
+         } catch (\Exception $e) {
+             Log::error('Zoom API呼び出し中に例外が発生しました。', [
+                 'message' => $e->getMessage(),
+                 'trace' => $e->getTraceAsString()
+             ]);
+             return false;
+         }
+     }
+ } 
+ 
```

---

_****_

JWTライブラリをComposerでインストールする必要があります。

---

_****_

```bash
composer require firebase/php-jwt
```

```
$ composer require firebase/php-jwt
./composer.json has been updated
Running composer update firebase/php-jwt
Loading composer repositories with package information
Updating dependencies
Lock file operations: 1 install, 0 updates, 0 removals
  - Locking firebase/php-jwt (v6.11.0)
Writing lock file
Installing dependencies from lock file (including require-dev)
Package operations: 1 install, 0 updates, 0 removals
  - Downloading firebase/php-jwt (v6.11.0)
  - Installing firebase/php-jwt (v6.11.0): Extracting archive
1 package suggestions were added by new dependencies, use `composer suggest` to see details.
Generating optimized autoload files
> Illuminate\Foundation\ComposerScripts::postAutoloadDump
> @php artisan package:discover --ansi

   INFO  Discovering packages.  

  barryvdh/laravel-debugbar ......................................................................... DONE
  laravel-lang/actions .............................................................................. DONE
  laravel-lang/attributes ........................................................................... DONE
  laravel-lang/config ............................................................................... DONE
  laravel-lang/http-statuses ........................................................................ DONE
  laravel-lang/lang ................................................................................. DONE
  laravel-lang/locales .............................................................................. DONE
  laravel-lang/models ............................................................................... DONE
  laravel-lang/moonshine ............................................................................ DONE
  laravel-lang/publisher ............................................................................ DONE
  laravel-lang/routes ............................................................................... DONE
  laravel-lang/starter-kits ......................................................................... DONE
  laravel/breeze .................................................................................... DONE
  laravel/pail ...................................................................................... DONE
  laravel/sail ...................................................................................... DONE
  laravel/tinker .................................................................................... DONE
  nesbot/carbon ..................................................................................... DONE
  nunomaduro/collision .............................................................................. DONE
  nunomaduro/termwind ............................................................................... DONE

88 packages you are using are looking for funding.
Use the `composer fund` command to find out more!
> @php artisan vendor:publish --tag=laravel-assets --ansi --force

   INFO  No publishable resources for tag [laravel-assets].  

Found 1 security vulnerability advisory affecting 1 package.
Run "composer audit" for a full list of advisories.
Using version ^6.11 for firebase/php-jwt
iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

次に、Zoom API設定をLaravelの設定ファイルに追加します。

---

_****_

```diff
      ],
  
+     'stripe' => [
+         'model' => App\Models\User::class,
+         'key' => env('STRIPE_KEY'),
+         'secret' => env('STRIPE_SECRET'),
+     ],
+ 
+     'zoom' => [
+         'api_key' => env('ZOOM_API_KEY'),
+         'api_secret' => env('ZOOM_API_SECRET'),
+         'api_url' => env('ZOOM_API_URL', 'https://api.zoom.us/v2/'),
+     ],
+ 
  ];
  
```

---

_****_

.envファイルにZoom API設定を追加します。

---

_****_

```diff
  
  VITE_APP_NAME="${APP_NAME}"
+ 
+ # Zoom API設定
+ ZOOM_API_KEY=your_zoom_api_key
+ ZOOM_API_SECRET=your_zoom_api_secret
+ ZOOM_API_URL=https://api.zoom.us/v2/
  
```

---

_****_

次に、BookingApiControllerを修正して、Zoom APIと連携した予約の作成と削除を実装します。

---

_****_

```diff
  use Illuminate\Support\Facades\Log;
  use Carbon\Carbon;
+ use App\Services\ZoomService;
  
  class BookingApiController extends Controller
  {
+     protected $zoomService;
+ 
+     public function __construct(ZoomService $zoomService)
+     {
+         $this->zoomService = $zoomService;
+     }
+ 
      /**
       * 予約一覧を取得 (カレンダー用)
          return response()->json($bookings, 200, [], JSON_UNESCAPED_UNICODE);
      }
+ 
+     /**
+      * 予約一覧を取得 (管理画面用)
+      */
+     public function list()
+     {
+         $bookings = Booking::orderBy('start', 'desc')->get();
+         return response()->json($bookings, 200, [], JSON_UNESCAPED_UNICODE);
+     }
  
      /**
              Log::info("予約削除リクエスト受信: ID=$id");
  
-             // 🔹 **IDが数値かどうかチェック**
+             // IDが数値かどうかチェック
              if (!is_numeric($id)) {
                  Log::error("無効な予約ID: $id");
              }
  
-             // 🔹 **予約を検索**
-             $booking = Booking::find($id); // **`findOrFail` ではなく `find` を使用**
+             // 予約を検索
+             $booking = Booking::find($id);
              if (!$booking) {
                  Log::warning("予約削除エラー (存在しないID): ID=$id");
                  ], 404);
              }
+ 
+             // ZoomミーティングIDがある場合、Zoom APIを使用して会議を削除
+             if ($booking->zoom_meeting_id) {
+                 $deleteResult = $this->zoomService->deleteMeeting($booking->zoom_meeting_id);
+                 if (!$deleteResult) {
+                     Log::warning("Zoom会議の削除に失敗しましたが、予約は削除します: Meeting ID={$booking->zoom_meeting_id}");
+                 }
+             }
  
              $booking->delete();
          }
      }
- 
  
      /**
              Log::info('予約リクエスト受信:', $request->all());
  
-             // 🔹 **バリデーション修正 (`date_format:Y-m-d H:i:s`)**
+             // バリデーション
              $validated = $request->validate([
                  'title' => 'required|string|max:255',
                  'start' => 'required|date_format:Y-m-d H:i:s',
                  'end' => 'required|date_format:Y-m-d H:i:s|after:start',
+                 'host_user_id' => 'nullable|string',
+                 'participant_email' => 'nullable|email',
+                 'waiting_room' => 'nullable|boolean',
+                 'max_participants' => 'nullable|integer|min:1|max:100',
              ]);
  
-             // 🔹 **データフォーマット統一 (日本時間に変換)**
+             // データフォーマット統一 (日本時間に変換)
              $validated['start'] = Carbon::parse($validated['start'])->setTimezone('Asia/Tokyo')->format('Y-m-d H:i:s');
              $validated['end'] = Carbon::parse($validated['end'])->setTimezone('Asia/Tokyo')->format('Y-m-d H:i:s');
  
-             // 🔹 **データの保存**
+             // デフォルト値の設定
+             $validated['waiting_room'] = $validated['waiting_room'] ?? true;
+             $validated['max_participants'] = $validated['max_participants'] ?? 10;
+ 
+             // Zoom会議の作成
+             $zoomMeeting = $this->zoomService->createMeeting([
+                 'title' => $validated['title'],
+                 'start' => $validated['start'],
+                 'end' => $validated['end'],
+                 'waiting_room' => $validated['waiting_room'],
+             ]);
+ 
+             if ($zoomMeeting) {
+                 // Zoom会議情報を追加
+                 $validated['zoom_meeting_id'] = $zoomMeeting['id'];
+                 $validated['zoom_meeting_url'] = $zoomMeeting['join_url'];
+                 $validated['zoom_meeting_password'] = $zoomMeeting['password'] ?? null;
+             } else {
+                 Log::warning('Zoom会議の作成に失敗しましたが、予約は作成します。');
+             }
+ 
+             // データの保存
              $booking = new Booking();
              $booking->fill($validated);
              $booking->save();
  
-             Log::info('予約成功:', ['id' => $booking->id]);
+             Log::info('予約成功:', ['id' => $booking->id, 'zoom_meeting_id' => $booking->zoom_meeting_id ?? 'なし']);
  
              return response()->json($booking, 201, [], JSON_UNESCAPED_UNICODE);
```

---

_****_

次に、ルートファイルに予約一覧取得のためのAPIルートを追加します。

---

_****_

```diff
  Route::get('/bookings', [BookingApiController::class, 'index']);
  Route::post('/bookings', [BookingApiController::class, 'store']);
+ 
+ // 予約一覧取得のためのAPIルート
+ Route::get('/api/bookings', [BookingApiController::class, 'list']);
  
  Route::get('/dashboard', function () {
```

---

_****_

次に、予約一覧を表示するビューとコントローラを作成します。

---

_****_

```diff
  
  use Illuminate\Http\Request;
+ use App\Models\Booking;
  
  class BookingController extends Controller
  {
+     /**
+      * カレンダー表示
+      */
      public function index()
      {
          return view('calendar');
      }
+ 
+     /**
+      * 予約一覧表示
+      */
+     public function list()
+     {
+         return view('bookings.list');
+     }
  }
  
```

---

_****_

ルートファイルに予約一覧表示用のルートを追加します。

---

_****_

```diff
  // 予約一覧取得のためのAPIルート
  Route::get('/api/bookings', [BookingApiController::class, 'list']);
+ 
+ // 予約一覧表示用のルート
+ Route::get('/bookings/list', [BookingController::class, 'list'])->name('bookings.list');
  
  Route::get('/dashboard', function () {
```

---

_****_

予約一覧表示用のビューを作成します。

---

_****_

```bash
mkdir -p resources/views/bookings
```

```
$ mkdir -p resources/views/bookings
iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

予約一覧表示用のビューファイルを作成します。

---

_****_

```diff
- 
+ @extends('layouts.app')
+ 
+ @section('content')
+ <div class="container">
+     <h2 class="mb-4">予約一覧</h2>
+     
+     <div class="mb-3">
+         <a href="{{ route('calendar') }}" class="btn btn-primary">カレンダーに戻る</a>
+     </div>
+ 
+     <div class="card">
+         <div class="card-body">
+             <div class="table-responsive">
+                 <table class="table table-hover" id="bookings-table">
+                     <thead>
+                         <tr>
+                             <th>ID</th>
+                             <th>タイトル</th>
+                             <th>開始日時</th>
+                             <th>終了日時</th>
+                             <th>主催者</th>
+                             <th>参加者メール</th>
+                             <th>Zoom URL</th>
+                             <th>待機室</th>
+                             <th>最大参加人数</th>
+                             <th>操作</th>
+                         </tr>
+                     </thead>
+                     <tbody id="bookings-list">
+                         <!-- 予約データが動的に挿入されます -->
+                     </tbody>
+                 </table>
+             </div>
+         </div>
+     </div>
+ </div>
+ 
+ <!-- CSRFトークンをmeta要素として設定 -->
+ <meta name="csrf-token" content="{{ csrf_token() }}">
+ 
+ <script>
+ document.addEventListener('DOMContentLoaded', function() {
+     // 予約一覧を取得して表示
+     fetchBookings();
+ 
+     function fetchBookings() {
+         fetch('/api/bookings')
+             .then(response => response.json())
+             .then(bookings => {
+                 renderBookings(bookings);
+             })
+             .catch(error => {
+                 console.error('予約データの取得に失敗しました:', error);
+                 alert('予約データの取得に失敗しました。');
+             });
+     }
+ 
+     function renderBookings(bookings) {
+         const bookingsList = document.getElementById('bookings-list');
+         bookingsList.innerHTML = '';
+ 
+         if (bookings.length === 0) {
+             const row = document.createElement('tr');
+             row.innerHTML = '<td colspan="10" class="text-center">予約がありません</td>';
+             bookingsList.appendChild(row);
+             return;
+         }
+ 
+         bookings.forEach(booking => {
+             const row = document.createElement('tr');
+             
+             // 日時をフォーマット
+             const startDate = new Date(booking.start);
+             const endDate = new Date(booking.end);
+             const formattedStart = formatDate(startDate);
+             const formattedEnd = formatDate(endDate);
+ 
+             // 待機室の状態を「有効/無効」で表示
+             const waitingRoom = booking.waiting_room ? '有効' : '無効';
+             
+             // Zoom URLのリンクを作成
+             const zoomLink = booking.zoom_meeting_url 
+                 ? `<a href="${booking.zoom_meeting_url}" target="_blank" class="btn btn-sm btn-info">Zoom URL</a>` 
+                 : 'なし';
+ 
+             row.innerHTML = `
+                 <td>${booking.id}</td>
+                 <td>${booking.title}</td>
+                 <td>${formattedStart}</td>
+                 <td>${formattedEnd}</td>
+                 <td>${booking.host_user_id || '未設定'}</td>
+                 <td>${booking.participant_email || '未設定'}</td>
+                 <td>${zoomLink}</td>
+                 <td>${waitingRoom}</td>
+                 <td>${booking.max_participants || '未設定'}</td>
+                 <td>
+                     <button class="btn btn-sm btn-danger delete-booking" data-id="${booking.id}">削除</button>
+                 </td>
+             `;
+             
+             bookingsList.appendChild(row);
+         });
+ 
+         // 削除ボタンにイベントリスナーを設定
+         attachDeleteListeners();
+     }
+ 
+     function attachDeleteListeners() {
+         const deleteButtons = document.querySelectorAll('.delete-booking');
+         deleteButtons.forEach(button => {
+             button.addEventListener('click', function() {
+                 const bookingId = this.getAttribute('data-id');
+                 if (confirm('この予約を削除してもよろしいですか？')) {
+                     deleteBooking(bookingId);
+                 }
+             });
+         });
+     }
+ 
+     function deleteBooking(id) {
+         fetch(`/bookings/${id}`, {
+             method: 'DELETE',
+             headers: {
+                 'Content-Type': 'application/json',
+                 'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
+             }
+         })
+         .then(response => {
+             if (!response.ok) {
+                 return response.json().then(errorData => {
+                     throw new Error(errorData.error || "予約の削除に失敗しました");
+                 });
+             }
+             return response.json();
+         })
+         .then(data => {
+             console.log('予約削除成功:', data);
+             // 削除後に予約一覧を再取得
+             fetchBookings();
+         })
+         .catch(error => {
+             console.error('エラー:', error);
+             alert('予約の削除に失敗しました。エラー: ' + error.message);
+         });
+     }
+ 
+     // 日付フォーマット用の関数
+     function formatDate(date) {
+         const year = date.getFullYear();
+         const month = String(date.getMonth() + 1).padStart(2, '0');
+         const day = String(date.getDate()).padStart(2, '0');
+         const hours = String(date.getHours()).padStart(2, '0');
+         const minutes = String(date.getMinutes()).padStart(2, '0');
+         
+         return `${year}/${month}/${day} ${hours}:${minutes}`;
+     }
+ });
+ </script>
+ 
+ <style>
+     .table th, .table td {
+         vertical-align: middle;
+     }
+ </style>
+ @endsection 
+ 
```

---

_****_

最後に、カレンダーの予約作成フォームを修正して、参加者情報を入力できるようにします。

---

_****_

```diff
              @endfor
          </select>
+ 
+         <label class="modal-label">参加者メールアドレス:</label>
+         <input type="email" id="participantEmail" class="modal-input" placeholder="参加者のメールアドレス">
+ 
+         <div class="modal-checkbox">
+             <input type="checkbox" id="waitingRoom" checked>
+             <label for="waitingRoom">待機室を有効にする</label>
+         </div>
  
          <div class="modal-actions">
```

---

_****_



次に、予約保存処理を修正して、Zoom関連の情報を送信するようにします。

---

_****_

```diff
                      ("0" + endDateTime.getMinutes()).slice(-2) + ":00";
  
+                 // Zoom関連の情報を取得
+                 var participantEmail = document.getElementById('participantEmail').value;
+                 var waitingRoom = document.getElementById('waitingRoom').checked;
+ 
                  console.log("送信データ:", JSON.stringify({
                      title: "予約",
                      start: formattedStart,
-                     end: formattedEnd
+                     end: formattedEnd,
+                     participant_email: participantEmail,
+                     waiting_room: waitingRoom
                  }));
  
                              title: "予約",
                              start: formattedStart,
-                             end: formattedEnd
+                             end: formattedEnd,
+                             participant_email: participantEmail,
+                             waiting_room: waitingRoom
                          })
                      })
```

---

_****_

最後に、カレンダーページにナビゲーションリンクを追加して、予約一覧ページに移動できるようにします。

---

_****_

```diff
      <div class="container">
          <h2>予約カレンダー</h2>
+         <div class="mb-3">
+             <a href="{{ route('bookings.list') }}" class="btn btn-info">予約一覧を表示</a>
+         </div>
          <div id="calendar"></div>
      </div>
```

---

_****_

これで、Zoom APIと連携した予約システムの実装が完了しました。以下の機能が実装されています：

1. カレンダーからの予約作成（Zoom会議も自動作成）
2. 予約一覧の表示（Zoom会議URLも表示）
3. 予約の削除（Zoom会議も自動削除）

実装内容をまとめます：

---

_****_

```bash
php artisan route:list | grep bookings
```

```
$ sail artisan route:list | grep bookings
  GET|HEAD  api/bookings ........................... BookingApiController@list
  POST      api/bookings .......................... BookingApiController@store
  DELETE    api/bookings/{id} ................... BookingApiController@destroy
  GET|HEAD  bookings .............................. BookingApiController@index
  POST      bookings .............................. BookingApiController@store
  GET|HEAD  bookings/list ............. bookings.list › BookingController@list
  DELETE    bookings/{id} .... bookings.destroy › BookingApiController@destroy
iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

以上で、Zoom APIと連携したオンラインミーティング予約システムの実装が完了しました。

## 実装内容のまとめ

1. **データベース設計**
   - Bookingテーブルに以下のZoom関連フィールドを追加
     - host_user_id: 主催者情報
     - participant_email: 参加者メールアドレス
     - zoom_meeting_id: Zoom会議ID
     - zoom_meeting_url: Zoom会議URL
     - zoom_meeting_password: Zoom会議パスワード
     - waiting_room: 待機室の有効/無効
     - max_participants: 最大参加人数

2. **Zoom API連携**
   - ZoomServiceクラスを作成し、以下の機能を実装
     - JWT認証トークンの生成
     - Zoom会議の作成
     - Zoom会議の取得
     - Zoom会議の削除

3. **コントローラの実装**
   - BookingApiControllerを拡張
     - 予約作成時にZoom会議も作成
     - 予約削除時にZoom会議も削除
     - 予約一覧取得API

4. **ビューの実装**
   - カレンダービューの拡張
     - 参加者メールアドレス入力フィールドの追加
     - 待機室設定のチェックボックスの追加
   - 予約一覧ビューの作成
     - 予約の詳細表示（日時、主催者、参加者、Zoom URL、待機室設定など）
     - 予約の削除機能

5. **ルーティング**
   - 予約一覧表示用のルート
   - 予約一覧取得APIルート

## 使用方法

1. カレンダーページ（/calendar）で日付を選択し、時間枠、参加者メール、待機室設定を入力して予約を作成
2. 予約が作成されると、自動的にZoom会議も作成される
3. 予約一覧ページ（/bookings/list）で作成された予約とZoom会議の詳細を確認
4. 予約を削除すると、関連するZoom会議も自動的に削除される

## 注意点

実際に使用する場合は、以下の点に注意してください：

1. .envファイルに有効なZoom API KeyとSecretを設定する必要があります
2. Zoom APIの利用制限に注意してください
3. 本番環境では、適切なユーザー認証と権限管理を実装することをお勧めします

---

_**User**_

ZOOM_ACCOUNT_ID=
ZOOM_CLIENT_ID=
ZOOM_CLIENT_SECRET=
ZOOM_API_BASE_URL=

提供されたものがこちらなのですが、いまの.envをこちらでうわがいてもいい？

---

_**Assistant**_

<think>ユーザーは新しいZoom API認証情報を提供してくれました。これは現在の`.env`ファイルにある設定とは異なっています。

現在の`.env`ファイルには次のようなZoom設定があります:
```
# Zoom API設定
ZOOM_API_KEY=your_zoom_api_key
ZOOM_API_SECRET=your_zoom_api_secret
ZOOM_API_URL=https://api.zoom.us/v2/
```

一方、ユーザーが提供した新しい設定は:
```
ZOOM_ACCOUNT_ID=
ZOOM_CLIENT_ID=
ZOOM_CLIENT_SECRET=
ZOOM_API_BASE_URL=
```

これはZoomのサーバー間OAuth認証に切り替えるための設定のようです。Zoomは従来のJWT認証から、OAuth認証への移行を推奨しています。

ユーザーの質問は、新しい設定で古い設定を上書きしても良いかということですが、単純に上書きするだけでは動作しなくなります。なぜなら、アプリケーションコードでは古い認証方式を使用しているからです。

正確には:
1. ZoomServiceクラスは現在JWT認証を使用している
2. コードは`ZOOM_API_KEY`と`ZOOM_API_SECRET`を期待している
3. 新しい認証方式では異なるロジックが必要

従って、回答では新しい認証情報に切り替えることは可能だが、それに伴いコードも修正する必要があることを説明すべきです。</think>はい、新しい認証情報で現在の`.env`のZoom設定を上書きすることは可能ですが、単純に置き換えるだけでは動作しません。

現在の実装ではJWT認証方式を使用していますが、提供された新しい認証情報はZoomのサーバー間OAuth認証用のものです。ZoomはJWT認証からOAuth認証への移行を推奨しているため、この変更は良い方向性ですが、コードも更新する必要があります。

以下の変更が必要になります：

1. `.env`ファイルを更新
2. `ZoomService.php`クラスの認証ロジックを修正

まず、`.env`ファイルを更新しましょう：

---

_****_

```diff
  
  # Zoom API設定
- ZOOM_API_KEY=your_zoom_api_key
- ZOOM_API_SECRET=your_zoom_api_secret
- ZOOM_API_URL=https://api.zoom.us/v2/
+ ZOOM_ACCOUNT_ID=
+ ZOOM_CLIENT_ID=
+ ZOOM_CLIENT_SECRET=
+ ZOOM_API_BASE_URL=https://api.zoom.us/v2/
  
  
```

---

_****_

次に、サービス設定ファイルを更新します：

---

_****_

```diff
  
      'zoom' => [
-         'api_key' => env('ZOOM_API_KEY'),
-         'api_secret' => env('ZOOM_API_SECRET'),
-         'api_url' => env('ZOOM_API_URL', 'https://api.zoom.us/v2/'),
+         'account_id' => env('ZOOM_ACCOUNT_ID'),
+         'client_id' => env('ZOOM_CLIENT_ID'),
+         'client_secret' => env('ZOOM_CLIENT_SECRET'),
+         'api_base_url' => env('ZOOM_API_BASE_URL', 'https://api.zoom.us/v2/'),
      ],
  
```

---

_****_

最後に、`ZoomService`クラスをOAuth認証方式に更新する必要があります：

---

_****_

```diff
  use Illuminate\Support\Facades\Http;
  use Illuminate\Support\Facades\Log;
+ use Illuminate\Support\Facades\Cache;
  
  class ZoomService
  {
-     protected $apiKey;
-     protected $apiSecret;
-     protected $apiUrl;
-     protected $jwt;
+     protected $accountId;
+     protected $clientId;
+     protected $clientSecret;
+     protected $apiBaseUrl;
+     protected $accessToken;
  
      public function __construct()
      {
-         $this->apiKey = config('services.zoom.api_key');
-         $this->apiSecret = config('services.zoom.api_secret');
-         $this->apiUrl = config('services.zoom.api_url');
-         $this->jwt = $this->generateJWT();
+         $this->accountId = config('services.zoom.account_id');
+         $this->clientId = config('services.zoom.client_id');
+         $this->clientSecret = config('services.zoom.client_secret');
+         $this->apiBaseUrl = config('services.zoom.api_base_url');
+         $this->accessToken = $this->getAccessToken();
      }
  
      /**
-      * Zoom JWT トークンを生成する
+      * Zoomアクセストークンを取得する
+      * キャッシュを利用して、有効期限内のトークンを再利用
       */
-     protected function generateJWT()
-     {
-         $key = $this->apiKey;
-         $secret = $this->apiSecret;
- 
-         $token = [
-             'iss' => $key,
-             'exp' => time() + 60 * 60, // 1時間の有効期限
-         ];
- 
-         // JWTライブラリを使用してトークンを生成
-         $jwt = \Firebase\JWT\JWT::encode($token, $secret, 'HS256');
- 
-         return $jwt;
+     protected function getAccessToken()
+     {
+         // キャッシュからトークンを取得
+         if (Cache::has('zoom_access_token')) {
+             return Cache::get('zoom_access_token');
+         }
+ 
+         try {
+             // OAuth認証でアクセストークンを取得
+             $response = Http::withBasicAuth($this->clientId, $this->clientSecret)
+                 ->asForm()
+                 ->post('https://zoom.us/oauth/token', [
+                     'grant_type' => 'account_credentials',
+                     'account_id' => $this->accountId,
+                 ]);
+ 
+             if ($response->successful()) {
+                 $tokenData = $response->json();
+                 $accessToken = $tokenData['access_token'];
+                 $expiresIn = $tokenData['expires_in'] - 60; // 1分早く期限切れにする
+ 
+                 // トークンをキャッシュに保存
+                 Cache::put('zoom_access_token', $accessToken, now()->addSeconds($expiresIn));
+ 
+                 return $accessToken;
+             } else {
+                 Log::error('Zoomアクセストークンの取得に失敗しました。', [
+                     'status' => $response->status(),
+                     'response' => $response->json()
+                 ]);
+                 return null;
+             }
+         } catch (\Exception $e) {
+             Log::error('Zoom OAuth認証中に例外が発生しました。', [
+                 'message' => $e->getMessage(),
+                 'trace' => $e->getTraceAsString()
+             ]);
+             return null;
+         }
      }
  
      public function createMeeting(array $data)
      {
+         if (!$this->accessToken) {
+             Log::error('Zoomアクセストークンがないため、会議を作成できません。');
+             return false;
+         }
+ 
          try {
              $response = Http::withHeaders([
-                 'Authorization' => 'Bearer ' . $this->jwt,
+                 'Authorization' => 'Bearer ' . $this->accessToken,
                  'Content-Type' => 'application/json',
-             ])->post($this->apiUrl . 'users/me/meetings', [
+             ])->post($this->apiBaseUrl . 'users/me/meetings', [
                  'topic' => $data['title'] ?? 'オンラインミーティング',
                  'type' => 2, // スケジュールされたミーティング
      public function getMeeting($meetingId)
      {
+         if (!$this->accessToken) {
+             Log::error('Zoomアクセストークンがないため、会議情報を取得できません。');
+             return false;
+         }
+ 
          try {
              $response = Http::withHeaders([
-                 'Authorization' => 'Bearer ' . $this->jwt,
+                 'Authorization' => 'Bearer ' . $this->accessToken,
                  'Content-Type' => 'application/json',
-             ])->get($this->apiUrl . 'meetings/' . $meetingId);
+             ])->get($this->apiBaseUrl . 'meetings/' . $meetingId);
  
              if ($response->successful()) {
      public function deleteMeeting($meetingId)
      {
+         if (!$this->accessToken) {
+             Log::error('Zoomアクセストークンがないため、会議を削除できません。');
+             return false;
+         }
+ 
          try {
              $response = Http::withHeaders([
-                 'Authorization' => 'Bearer ' . $this->jwt,
+                 'Authorization' => 'Bearer ' . $this->accessToken,
                  'Content-Type' => 'application/json',
-             ])->delete($this->apiUrl . 'meetings/' . $meetingId);
+             ])->delete($this->apiBaseUrl . 'meetings/' . $meetingId);
  
              if ($response->successful()) {
```

---

_****_

これで認証方式を変更できました。以下の変更を行いました：

1. `.env` ファイルのZoom API設定を新しい認証情報に更新
2. `config/services.php` のZoom設定を新しい認証情報に合わせて変更
3. `ZoomService.php` クラスをJWT認証からOAuth認証方式に変更

### 重要な更新内容

1. **認証方式の変更**：
   - JWT認証からサーバー間OAuth認証に変更
   - アクセストークンをキャッシュするロジックを追加（トークンの有効期限内は再利用）

2. **エラーハンドリングの強化**：
   - アクセストークンがない場合のチェックを追加
   - より詳細なエラーログ

### 使用上の注意

1. `.env` ファイルに実際の認証情報を入力する必要があります：
   ```
   ZOOM_ACCOUNT_ID=あなたのアカウントID
   ZOOM_CLIENT_ID=あなたのクライアントID
   ZOOM_CLIENT_SECRET=あなたのクライアントシークレット
   ```

2. 新しい認証情報はZoomの開発者ポータルで取得する必要があります。
   - Zoomの[App Marketplace](https://marketplace.zoom.us/develop/create)でサーバー間OAuth appを作成
   - 必要な権限（Scopes）を設定（meeting:write、meeting:read）

3. アプリケーションをテストして、Zoom API連携が正常に動作することを確認してください。

この変更により、ZoomのAPIセキュリティ要件に準拠した、より安全な認証方式を使用できるようになりました。

---

_**User**_

このページから予約ができるようにしたい。

---

_**Assistant**_

予約一覧ページから新しい予約を作成できるようにするためには、以下の手順を実行します。

1. **予約作成用のモーダルを追加**: 予約一覧ページに新しい予約を作成するためのモーダルを追加します。
2. **JavaScriptでモーダルの表示とデータ送信を処理**: モーダルを開くボタンを作成し、モーダル内のフォームからデータを送信するためのJavaScriptを追加します。

以下の手順で実装を進めます。

### 1. 予約作成用のモーダルを追加

`resources/views/bookings/list.blade.php`にモーダルを追加します。

```html
<!-- モーダルオーバーレイ -->
<div id="modalOverlay" class="modal-overlay"></div>

<!-- モーダル -->
<div id="bookingModal" class="modal">
    <h3 class="modal-title">予約を追加</h3>

    <label class="modal-label">タイトル:</label>
    <input type="text" id="bookingTitle" class="modal-input" placeholder="予約のタイトル">

    <label class="modal-label">開始日時:</label>
    <input type="datetime-local" id="bookingStart" class="modal-input">

    <label class="modal-label">終了日時:</label>
    <input type="datetime-local" id="bookingEnd" class="modal-input">

    <label class="modal-label">参加者メールアドレス:</label>
    <input type="email" id="participantEmail" class="modal-input" placeholder="参加者のメールアドレス">

    <div class="modal-checkbox">
        <input type="checkbox" id="waitingRoom" checked>
        <label for="waitingRoom">待機室を有効にする</label>
    </div>

    <div class="modal-actions">
        <button id="saveBooking" class="btn btn-primary">予約する</button>
        <button id="closeModal" class="btn btn-secondary">キャンセル</button>
    </div>
</div>
```

### 2. JavaScriptでモーダルの表示とデータ送信を処理

モーダルを開くボタンを追加し、JavaScriptでモーダルの表示とデータ送信を処理します。

```javascript
document.addEventListener('DOMContentLoaded', function() {
    // 予約作成ボタンを追加
    const createBookingButton = document.createElement('button');
    createBookingButton.innerText = '新しい予約を作成';
    createBookingButton.className = 'btn btn-success mb-3';
    createBookingButton.addEventListener('click', openModal);
    document.querySelector('.container').prepend(createBookingButton);

    // モーダルを開く関数
    function openModal() {
        document.getElementById('bookingModal').style.display = 'block';
        document.getElementById('modalOverlay').style.display = 'block';
    }

    // モーダルを閉じる関数
    function closeModal() {
        document.getElementById('bookingModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }

    // 予約を保存する処理
    document.getElementById('saveBooking').addEventListener('click', function() {
        const title = document.getElementById('bookingTitle').value;
        const start = document.getElementById('bookingStart').value;
        const end = document.getElementById('bookingEnd').value;
        const participantEmail = document.getElementById('participantEmail').value;
        const waitingRoom = document.getElementById('waitingRoom').checked;

        fetch('/bookings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({
                title: title,
                start: start,
                end: end,
                participant_email: participantEmail,
                waiting_room: waitingRoom
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('予約成功:', data);
            fetchBookings(); // 予約一覧を再取得
            closeModal(); // モーダルを閉じる
        })
        .catch(error => {
            console.error('エラー:', error);
            alert('予約の登録に失敗しました。エラー: ' + error.message);
        });
    });

    document.getElementById('closeModal').addEventListener('click', closeModal);
    document.getElementById('modalOverlay').addEventListener('click', closeModal);
});
```

### 3. 完成したコード

これで、予約一覧ページから新しい予約を作成できるようになります。モーダルを開いて必要な情報を入力し、予約を作成することができます。

---

_**User**_

このページでは予約されたズームのリストを取得して、そのミーティングにユーザーが参加の意思を表明するところです。予約ボタンを押すと該当のMTに予約したユーザーにMTの参加に必要なURLが渡される仕組みにしたい。

また、デザインのためのJavaScriptはいいですが、基本MVCモデルを使った開発をしてください。

---

_**Assistant**_

<think>ユーザーからの要求を整理します：

1. 予約一覧ページ（bookings/list.blade.php）で、Zoomミーティングのリストを表示する
2. ユーザーが「予約」ボタンを押すと、そのミーティングに参加登録する
3. 参加登録したユーザーに、ミーティングに参加するためのURLを提供する
4. MVCモデルを使用して開発する（JavaScriptでの実装ではなく、Laravelの機能を活用）

現在の実装を考慮しながら、以下のステップで修正を行うべきです：

1. ミーティング参加のための新しいモデル（MeetingParticipant）を作成
2. 予約一覧を表示するコントローラーメソッドを修正
3. 予約参加のためのルートとコントローラーメソッドを追加
4. ビューを修正して予約ボタンを追加
5. 参加確認や詳細表示のためのビューを作成

これはMVCモデルに従って実装する必要があります。</think>MVCモデルに沿って、Zoomミーティングへの参加予約機能を実装しましょう。以下の手順で開発を進めます。

### 1. まず、ミーティング参加者を管理するためのモデルとマイグレーションを作成します

---

_****_

```bash
php artisan make:model MeetingParticipant -m
```

```

   INFO  Model [app/Models/MeetingParticipant.php] created successfully.  

   INFO  Migration [database/migrations/2025_03_10_012427_create_meeting_participants_table.php] created suc
cessfully.


```

---

_****_

### 2. マイグレーションファイルを編集して、必要なカラムを追加します

---

_****_

Read file: undefined

---

_****_

```diff
          Schema::create('meeting_participants', function (Blueprint $table) {
              $table->id();
+             $table->foreignId('booking_id')->constrained()->onDelete('cascade');
+             $table->string('name');
+             $table->string('email');
+             $table->string('access_token')->unique(); // 参加用の一意のトークン
+             $table->boolean('email_sent')->default(false);
+             $table->timestamp('registered_at')->useCurrent();
              $table->timestamps();
          });
```

---

_****_

### 3. モデルを編集して、フィールドとリレーションシップを定義します

---

_****_

Read file: undefined

---

_****_

```diff
  namespace App\Models;
  
+ use Illuminate\Database\Eloquent\Factories\HasFactory;
  use Illuminate\Database\Eloquent\Model;
+ use Illuminate\Support\Str;
  
  class MeetingParticipant extends Model
  {
-     //
+     use HasFactory;
+ 
+     /**
+      * The attributes that are mass assignable.
+      *
+      * @var array
+      */
+     protected $fillable = [
+         'booking_id',
+         'name',
+         'email',
+         'access_token',
+         'email_sent',
+     ];
+ 
+     /**
+      * The attributes that should be cast.
+      *
+      * @var array
+      */
+     protected $casts = [
+         'email_sent' => 'boolean',
+         'registered_at' => 'datetime',
+     ];
+ 
+     /**
+      * 参加者が属する予約
+      */
+     public function booking()
+     {
+         return $this->belongsTo(Booking::class);
+     }
+ 
+     /**
+      * アクセストークンを生成
+      *
+      * @return string
+      */
+     public static function generateAccessToken()
+     {
+         return Str::random(64);
+     }
  }
  
```

---

_****_

### 4. Bookingモデルにリレーションを追加

---

_****_

```diff
          'max_participants'
      ];
+ 
+     /**
+      * この予約に参加登録したユーザー
+      */
+     public function participants()
+     {
+         return $this->hasMany(MeetingParticipant::class);
+     }
  }
  
```

---

_****_

### 5. マイグレーションを実行

---

_****_

```bash
php artisan migrate
```

```
$ sail artisan migrate

   INFO  Running migrations.  

  2025_03_10_012427_create_meeting_participants_table ....................................... 18.37ms DONE

iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

### 6. ミーティング参加登録用のコントローラを作成

---

_****_

```bash
php artisan make:controller MeetingParticipantController
```

```
$ sail artisan make:controller MeetingParticipantController

   INFO  Controller [app/Http/Controllers/MeetingParticipantController.php] created successfully.  

iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

### 7. コントローラの実装

---

_****_

```diff
  namespace App\Http\Controllers;
  
+ use App\Models\Booking;
+ use App\Models\MeetingParticipant;
  use Illuminate\Http\Request;
+ use Illuminate\Support\Facades\Log;
+ use Illuminate\Support\Facades\Mail;
  
  class MeetingParticipantController extends Controller
  {
-     //
+     /**
+      * ミーティング参加フォームを表示
+      */
+     public function showRegistrationForm($id)
+     {
+         $booking = Booking::findOrFail($id);
+         return view('meetings.register', compact('booking'));
+     }
+ 
+     /**
+      * ミーティングへの参加を登録
+      */
+     public function register(Request $request, $id)
+     {
+         $booking = Booking::findOrFail($id);
+         
+         // バリデーション
+         $validated = $request->validate([
+             'name' => 'required|string|max:255',
+             'email' => 'required|email|max:255',
+         ]);
+         
+         // 既に登録していないかチェック
+         $existingParticipant = MeetingParticipant::where('booking_id', $booking->id)
+             ->where('email', $validated['email'])
+             ->first();
+             
+         if ($existingParticipant) {
+             return redirect()->route('meetings.registration.complete', ['token' => $existingParticipant->access_token])
+                 ->with('message', '既に登録されています。');
+         }
+         
+         // 新規参加者を登録
+         $accessToken = MeetingParticipant::generateAccessToken();
+         
+         $participant = new MeetingParticipant([
+             'booking_id' => $booking->id,
+             'name' => $validated['name'],
+             'email' => $validated['email'],
+             'access_token' => $accessToken,
+         ]);
+         
+         $participant->save();
+         
+         // メール送信処理を追加することも可能（実装は省略）
+         
+         return redirect()->route('meetings.registration.complete', ['token' => $accessToken]);
+     }
+     
+     /**
+      * 登録完了・ミーティング参加情報表示
+      */
+     public function showRegistrationComplete($token)
+     {
+         $participant = MeetingParticipant::where('access_token', $token)->firstOrFail();
+         $booking = $participant->booking;
+         
+         return view('meetings.complete', compact('participant', 'booking'));
+     }
  }
  
```

---

_****_

### 8. ルートを追加

---

_****_

```diff
  use App\Http\Controllers\BookingController;
  use App\Http\Controllers\BookingApiController;
+ use App\Http\Controllers\MeetingParticipantController;
  
  Route::get('/', function () {
  // 予約一覧表示用のルート
  Route::get('/bookings/list', [BookingController::class, 'list'])->name('bookings.list');
+ 
+ // ミーティング参加登録用のルート
+ Route::get('/meetings/{id}/register', [MeetingParticipantController::class, 'showRegistrationForm'])->name('meetings.register');
+ Route::post('/meetings/{id}/register', [MeetingParticipantController::class, 'register'])->name('meetings.register.post');
+ Route::get('/meetings/complete/{token}', [MeetingParticipantController::class, 'showRegistrationComplete'])->name('meetings.registration.complete');
  
  Route::get('/dashboard', function () {
```

---

_****_

### 9. 予約一覧ページ（Bookingコントローラ）を修正

---

_****_

```diff
      public function list()
      {
-         return view('bookings.list');
+         $bookings = Booking::orderBy('start', 'desc')->get();
+         return view('bookings.list', compact('bookings'));
      }
  }
```

---

_****_

### 10. ビューディレクトリを作成

---

_****_

```bash
mkdir -p resources/views/meetings
```

```
$ mkdir -p resources/views/meetings
iroiropro@Iropro:~/camp/100_Laravel/Reservation_Calendar (main *)
$
```

---

_****_

### 11. 予約一覧ビュー（bookings.list）を修正

---

_****_

```diff
                                  <th>終了日時</th>
                                  <th>主催者</th>
-                                 <th>参加者メール</th>
                                  <th>Zoom URL</th>
                                  <th>待機室</th>
                              </tr>
                          </thead>
-                         <tbody id="bookings-list">
-                             <!-- 予約データが動的に挿入されます -->
+                         <tbody>
+                             @if(count($bookings) === 0)
+                                 <tr>
+                                     <td colspan="9" class="text-center">予約がありません</td>
+                                 </tr>
+                             @else
+                                 @foreach($bookings as $booking)
+                                     <tr>
+                                         <td>{{ $booking->id }}</td>
+                                         <td>{{ $booking->title }}</td>
+                                         <td>{{ \Carbon\Carbon::parse($booking->start)->format('Y/m/d H:i') }}</td>
+                                         <td>{{ \Carbon\Carbon::parse($booking->end)->format('Y/m/d H:i') }}</td>
+                                         <td>{{ $booking->host_user_id ?? '未設定' }}</td>
+                                         <td>
+                                             @if($booking->zoom_meeting_url)
+                                                 <a href="{{ $booking->zoom_meeting_url }}" target="_blank" class="btn btn-sm btn-info">Zoom URL</a>
+                                             @else
+                                                 なし
+                                             @endif
+                                         </td>
+                                         <td>{{ $booking->waiting_room ? '有効' : '無効' }}</td>
+                                         <td>{{ $booking->max_participants ?? '未設定' }}</td>
+                                         <td>
+                                             <div class="btn-group" role="group">
+                                                 <a href="{{ route('meetings.register', $booking->id) }}" class="btn btn-sm btn-success">予約する</a>
+                                                 
+                                                 @auth
+                                                 <form action="{{ route('bookings.destroy', $booking->id) }}" method="POST" class="d-inline" onsubmit="return confirm('この予約を削除してもよろしいですか？');">
+                                                     @csrf
+                                                     @method('DELETE')
+                                                     <button type="submit" class="btn btn-sm btn-danger">削除</button>
+                                                 </form>
+                                                 @endauth
+                                             </div>
+                                         </td>
+                                     </tr>
+                                 @endforeach
+                             @endif
                          </tbody>
                      </table>
          </div>
      </div>
- 
-     <!-- CSRFトークンをmeta要素として設定 -->
-     <meta name="csrf-token" content="{{ csrf_token() }}">
- 
-     <script>
-         document.addEventListener('DOMContentLoaded', function() {
-             // 予約一覧を取得して表示
-             fetchBookings();
- 
-             function fetchBookings() {
-                 fetch('/api/bookings')
-                     .then(response => response.json())
-                     .then(bookings => {
-                         renderBookings(bookings);
-                     })
-                     .catch(error => {
-                         console.error('予約データの取得に失敗しました:', error);
-                         alert('予約データの取得に失敗しました。');
-                     });
-             }
- 
-             function renderBookings(bookings) {
-                 const bookingsList = document.getElementById('bookings-list');
-                 bookingsList.innerHTML = '';
- 
-                 if (bookings.length === 0) {
-                     const row = document.createElement('tr');
-                     row.innerHTML = '<td colspan="10" class="text-center">予約がありません</td>';
-                     bookingsList.appendChild(row);
-                     return;
-                 }
- 
-                 bookings.forEach(booking => {
-                     const row = document.createElement('tr');
- 
-                     // 日時をフォーマット
-                     const startDate = new Date(booking.start);
-                     const endDate = new Date(booking.end);
-                     const formattedStart = formatDate(startDate);
-                     const formattedEnd = formatDate(endDate);
- 
-                     // 待機室の状態を「有効/無効」で表示
-                     const waitingRoom = booking.waiting_room ? '有効' : '無効';
- 
-                     // Zoom URLのリンクを作成
-                     const zoomLink = booking.zoom_meeting_url ?
-                         `<a href="${booking.zoom_meeting_url}" target="_blank" class="btn btn-sm btn-info">Zoom URL</a>` :
-                         'なし';
- 
-                     row.innerHTML = `
-                 <td>${booking.id}</td>
-                 <td>${booking.title}</td>
-                 <td>${formattedStart}</td>
-                 <td>${formattedEnd}</td>
-                 <td>${booking.host_user_id || '未設定'}</td>
-                 <td>${booking.participant_email || '未設定'}</td>
-                 <td>${zoomLink}</td>
-                 <td>${waitingRoom}</td>
-                 <td>${booking.max_participants || '未設定'}</td>
-                 <td>
-                     <button class="btn btn-sm btn-danger delete-booking" data-id="${booking.id}">削除</button>
-                 </td>
-             `;
- 
-                     bookingsList.appendChild(row);
-                 });
- 
-                 // 削除ボタンにイベントリスナーを設定
-                 attachDeleteListeners();
-             }
- 
-             function attachDeleteListeners() {
-                 const deleteButtons = document.querySelectorAll('.delete-booking');
-                 deleteButtons.forEach(button => {
-                     button.addEventListener('click', function() {
-                         const bookingId = this.getAttribute('data-id');
-                         if (confirm('この予約を削除してもよろしいですか？')) {
-                             deleteBooking(bookingId);
-                         }
-                     });
-                 });
-             }
- 
-             function deleteBooking(id) {
-                 fetch(`/bookings/${id}`, {
-                         method: 'DELETE',
-                         headers: {
-                             'Content-Type': 'application/json',
-                             'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute(
-                                 'content')
-                         }
-                     })
-                     .then(response => {
-                         if (!response.ok) {
-                             return response.json().then(errorData => {
-                                 throw new Error(errorData.error || "予約の削除に失敗しました");
-                             });
-                         }
-                         return response.json();
-                     })
-                     .then(data => {
-                         console.log('予約削除成功:', data);
-                         // 削除後に予約一覧を再取得
-                         fetchBookings();
-                     })
-                     .catch(error => {
-                         console.error('エラー:', error);
-                         alert('予約の削除に失敗しました。エラー: ' + error.message);
-                     });
-             }
- 
-             // 日付フォーマット用の関数
-             function formatDate(date) {
-                 const year = date.getFullYear();
-                 const month = String(date.getMonth() + 1).padStart(2, '0');
-                 const day = String(date.getDate()).padStart(2, '0');
-                 const hours = String(date.getHours()).padStart(2, '0');
-                 const minutes = String(date.getMinutes()).padStart(2, '0');
- 
-                 return `${year}/${month}/${day} ${hours}:${minutes}`;
-             }
-         });
-     </script>
  
      <style>
```

---

_****_

### 12. ミーティング参加登録フォームのビューを作成

---

_****_

```diff
- 
+ @extends('layouts.app')
+ 
+ @section('content')
+ <div class="container">
+     <div class="row justify-content-center">
+         <div class="col-md-8">
+             <div class="card">
+                 <div class="card-header">ミーティング参加登録</div>
+ 
+                 <div class="card-body">
+                     <h4>{{ $booking->title }}</h4>
+                     <p>開始時間: {{ \Carbon\Carbon::parse($booking->start)->format('Y年m月d日 H:i') }}</p>
+                     <p>終了時間: {{ \Carbon\Carbon::parse($booking->end)->format('Y年m月d日 H:i') }}</p>
+                     
+                     <hr>
+                     
+                     <form method="POST" action="{{ route('meetings.register.post', $booking->id) }}">
+                         @csrf
+                         
+                         <div class="form-group mb-3">
+                             <label for="name">お名前</label>
+                             <input id="name" type="text" class="form-control @error('name') is-invalid @enderror" name="name" value="{{ old('name') }}" required autofocus>
+                             @error('name')
+                                 <span class="invalid-feedback" role="alert">
+                                     <strong>{{ $message }}</strong>
+                                 </span>
+                             @enderror
+                         </div>
+ 
+                         <div class="form-group mb-3">
+                             <label for="email">メールアドレス</label>
+                             <input id="email" type="email" class="form-control @error('email') is-invalid @enderror" name="email" value="{{ old('email') }}" required>
+                             @error('email')
+                                 <span class="invalid-feedback" role="alert">
+                                     <strong>{{ $message }}</strong>
+                                 </span>
+                             @enderror
+                         </div>
+ 
+                         <div class="form-group mb-0">
+                             <button type="submit" class="btn btn-primary">
+                                 参加登録する
+                             </button>
+                             <a href="{{ route('bookings.list') }}" class="btn btn-secondary">
+                                 戻る
+                             </a>
+                         </div>
+                     </form>
+                 </div>
+             </div>
+         </div>
+     </div>
+ </div>
+ @endsection 
+ 
```

---

_****_

### 13. 参加登録完了・ミーティング参加情報ページを作成

---

_****_

```diff
- 
+ @extends('layouts.app')
+ 
+ @section('content')
+ <div class="container">
+     <div class="row justify-content-center">
+         <div class="col-md-8">
+             <div class="card">
+                 <div class="card-header">ミーティング参加登録完了</div>
+ 
+                 <div class="card-body">
+                     @if (session('message'))
+                         <div class="alert alert-info">
+                             {{ session('message') }}
+                         </div>
+                     @else
+                         <div class="alert alert-success">
+                             参加登録が完了しました。
+                         </div>
+                     @endif
+ 
+                     <h4 class="mt-4">ミーティング情報</h4>
+                     <div class="card mb-4">
+                         <div class="card-body">
+                             <h5>{{ $booking->title }}</h5>
+                             <p>開始時間: {{ \Carbon\Carbon::parse($booking->start)->format('Y年m月d日 H:i') }}</p>
+                             <p>終了時間: {{ \Carbon\Carbon::parse($booking->end)->format('Y年m月d日 H:i') }}</p>
+                         </div>
+                     </div>
+ 
+                     <h4>参加者情報</h4>
+                     <div class="card mb-4">
+                         <div class="card-body">
+                             <p>お名前: {{ $participant->name }}</p>
+                             <p>メールアドレス: {{ $participant->email }}</p>
+                         </div>
+                     </div>
+ 
+                     <h4>参加方法</h4>
+                     <div class="card mb-4">
+                         <div class="card-body">
+                             @if ($booking->zoom_meeting_url)
+                                 <p>ミーティング時間になりましたら、以下のURLからZoomミーティングに参加してください。</p>
+                                 <div class="d-grid gap-2">
+                                     <a href="{{ $booking->zoom_meeting_url }}" target="_blank" class="btn btn-primary btn-lg">Zoomミーティングに参加</a>
+                                 </div>
+                                 
+                                 @if ($booking->zoom_meeting_password)
+                                     <div class="mt-3">
+                                         <p>パスワードが求められた場合は、以下のパスワードを入力してください。</p>
+                                         <div class="input-group">
+                                             <input type="text" class="form-control" value="{{ $booking->zoom_meeting_password }}" readonly>
+                                             <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('{{ $booking->zoom_meeting_password }}')">コピー</button>
+                                         </div>
+                                     </div>
+                                 @endif
+                             @else
+                                 <p>Zoomミーティング情報がまだ設定されていません。主催者から直接ミーティングURLが送られる場合があります。</p>
+                             @endif
+                         </div>
+                     </div>
+ 
+                     <div class="text-center mt-4">
+                         <a href="{{ route('bookings.list') }}" class="btn btn-secondary">予約一覧に戻る</a>
+                     </div>
+                 </div>
+             </div>
+         </div>
+     </div>
+ </div>
+ 
+ <script>
+ function copyToClipboard(text) {
+     navigator.clipboard.writeText(text).then(function() {
+         alert('コピーしました');
+     }, function(err) {
+         console.error('コピーに失敗しました', err);
+     });
+ }
+ </script>
+ @endsection 
+ 
```

---

_****_

これでMVCモデルに沿った、Zoomミーティング参加機能の実装が完了しました。

## 実装内容のまとめ

### モデル
1. **MeetingParticipant**: ミーティング参加者を管理するモデル
   - Bookingとのリレーションを定義
   - 参加者の情報（名前、メール）やアクセストークンを保存

### コントローラ
1. **MeetingParticipantController**: ミーティング参加に関する機能を提供
   - `showRegistrationForm`: 参加登録フォームを表示
   - `register`: 参加者を登録
   - `showRegistrationComplete`: 参加登録完了・ミーティング情報表示

### ビュー
1. **resources/views/bookings/list.blade.php**: 予約一覧を表示し、「予約する」ボタンから参加登録へ誘導
2. **resources/views/meetings/register.blade.php**: 参加者情報入力フォーム
3. **resources/views/meetings/complete.blade.php**: 参加登録完了・ミーティング参加情報表示

### ルート
```php
Route::get('/meetings/{id}/register', [MeetingParticipantController::class, 'showRegistrationForm'])->name('meetings.register');
Route::post('/meetings/{id}/register', [MeetingParticipantController::class, 'register'])->name('meetings.register.post');
Route::get('/meetings/complete/{token}', [MeetingParticipantController::class, 'showRegistrationComplete'])->name('meetings.registration.complete');
```

## 機能の使い方

1. 予約一覧ページ（/bookings/list）にアクセスすると、Zoomミーティングの一覧が表示されます
2. 参加したいミーティングの「予約する」ボタンをクリックします
3. 名前とメールアドレスを入力して、参加登録します
4. 登録完了ページで、Zoomミーティングの参加URLとパスワードが表示されます
5. 表示されたURLをクリックすることで、ミーティングに参加できます

この実装により、MVCモデルに沿って、ユーザーがZoomミーティングに参加登録し、ミーティングURLを取得できる機能を提供できました。

---

_**User**_

GETメソッドにアクセスできるようにしてください
@Codebase 

---

_**Assistant**_

ユーザーのリクエストに基づいて、GETメソッドでミーティング参加登録ページにアクセスできるようにルートを設定します。以下の手順で進めます。

### 1. ルートの設定

`routes/web.php`にGETメソッドのルートを追加します。これにより、特定のミーティングに対する参加登録フォームにアクセスできるようになります。

```php
// ミーティング参加登録用のルート
Route::get('/meetings/{id}/register', [MeetingParticipantController::class, 'showRegistrationForm'])->name('meetings.register');
```

### 2. コントローラのメソッドを確認

`MeetingParticipantController`の`showRegistrationForm`メソッドが正しく実装されていることを確認します。このメソッドは、指定されたミーティングの参加登録フォームを表示します。

```php
public function showRegistrationForm($id)
{
    $booking = Booking::findOrFail($id);
    return view('meetings.register', compact('booking'));
}
```

### 3. ビューの確認

`resources/views/meetings/register.blade.php`が正しく作成されていることを確認します。このビューには、参加者が名前とメールアドレスを入力するためのフォームが含まれています。

### 4. ルートの確認

ルートが正しく設定されているか確認するために、以下のコマンドを実行してルート一覧を表示します。

```bash
sail artisan route:list
```

これにより、GETメソッドでのミーティング参加登録ページへのアクセスが可能になります。これで、ユーザーは指定されたミーティングに参加登録するためのフォームにアクセスできるようになります。

---

_**User**_

ダッシュボードにリンクを追加してくれればいいですよ

---

_**Assistant**_

ダッシュボードにミーティング参加登録ページへのリンクを追加するために、`resources/views/dashboard.blade.php`を修正します。以下の手順で進めます。

### 1. ダッシュボードビューの修正

`resources/views/dashboard.blade.php`に、ミーティング参加登録ページへのリンクを追加します。以下のようにコードを修正します。

```php
<x-app-layout>
    <x-slot name="header">
        <h2 class="font-semibold text-xl text-gray-800 leading-tight">
            {{ __('Dashboard') }}
        </h2>
    </x-slot>

    <div class="py-12">
        <div class="max-w-7xl mx-auto sm:px-6 lg:px-8">
            <div class="bg-white overflow-hidden shadow-sm sm:rounded-lg">
                <div class="p-6 text-gray-900">
                    {{ __("You're logged in!") }}
                </div>
                <div class="p-6 text-gray-900">
                    <a href="{{ route('bookings.list') }}" class="btn btn-primary">予約一覧に移動</a>
                    <a href="{{ route('meetings.register', ['id' => 1]) }}" class="btn btn-success">ミーティング参加登録</a>
                </div>
            </div>
        </div>
    </div>
</x-app-layout>
```

### 2. ルートの確認

`meetings.register`ルートは、特定のミーティングIDを必要とします。ダッシュボードに表示するリンクは、適切なミーティングIDを指定する必要があります。ここでは仮に`1`を使用していますが、実際のミーティングIDに置き換える必要があります。

### 3. 変更を保存

これで、ダッシュボードにミーティング参加登録ページへのリンクが追加されました。ユーザーはダッシュボードから直接ミーティング参加登録ページにアクセスできるようになります。

---

_**User**_

ダッシュボードには表示されないみたいなので、ナビゲーションに追加して

---

_**Assistant**_

ダッシュボードではなく、ナビゲーションメニューにミーティング参加登録ページへのリンクを追加するために、ナビゲーションバーのビューを修正します。通常、ナビゲーションバーは`resources/views/layouts/app.blade.php`などのファイルに定義されています。

以下の手順で進めます。

### 1. ナビゲーションバーの修正

`resources/views/layouts/app.blade.php`を開き、ナビゲーションメニューにミーティング参加登録ページへのリンクを追加します。

```php
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url('/') }}">Laravel</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="{{ route('calendar') }}">カレンダー</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ route('bookings.list') }}">予約一覧</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{{ route('meetings.register', ['id' => 1]) }}">ミーティング参加登録</a>
                </li>
                <!-- 他のナビゲーションリンク -->
            </ul>
        </div>
    </div>
</nav>
```

### 2. ルートの確認

`meetings.register`ルートは、特定のミーティングIDを必要とします。ここでは仮に`1`を使用していますが、実際のミーティングIDに置き換える必要があります。

### 3. 変更を保存

これで、ナビゲーションメニューにミーティング参加登録ページへのリンクが追加されました。ユーザーはナビゲーションバーから直接ミーティング参加登録ページにアクセスできるようになります。

---

_**User**_

ズームの予約を実装するにはどうしたらいいですか？

---

_**Assistant**_

Zoomの予約機能を実装するためには、以下の手順を踏む必要があります。これにより、ユーザーがZoomミーティングを予約し、その情報をデータベースに保存できるようになります。

### 1. Zoom APIの設定

まず、Zoom APIを使用するための設定を行います。

- **Zoomアカウントを作成**: Zoomの開発者アカウントを作成し、APIキーとシークレットを取得します。
- **OAuthアプリを作成**: ZoomのApp MarketplaceでOAuthアプリを作成し、必要なスコープ（permissions）を設定します。

### 2. 環境変数の設定

`.env`ファイルにZoom APIの設定を追加します。

```plaintext
ZOOM_ACCOUNT_ID=your_account_id
ZOOM_CLIENT_ID=your_client_id
ZOOM_CLIENT_SECRET=your_client_secret
ZOOM_API_BASE_URL=https://api.zoom.us/v2/
```

### 3. ZoomServiceクラスの実装

Zoom APIを呼び出すためのサービスクラスを作成します。このクラスでは、Zoomミーティングを作成するためのメソッドを実装します。

```php
namespace App\Services;

use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Cache;

class ZoomService
{
    protected $accountId;
    protected $clientId;
    protected $clientSecret;
    protected $apiBaseUrl;
    protected $accessToken;

    public function __construct()
    {
        $this->accountId = config('services.zoom.account_id');
        $this->clientId = config('services.zoom.client_id');
        $this->clientSecret = config('services.zoom.client_secret');
        $this->apiBaseUrl = config('services.zoom.api_base_url');
        $this->accessToken = $this->getAccessToken();
    }

    protected function getAccessToken()
    {
        // キャッシュからトークンを取得
        if (Cache::has('zoom_access_token')) {
            return Cache::get('zoom_access_token');
        }

        // OAuth認証でアクセストークンを取得
        $response = Http::withBasicAuth($this->clientId, $this->clientSecret)
            ->asForm()
            ->post('https://zoom.us/oauth/token', [
                'grant_type' => 'account_credentials',
                'account_id' => $this->accountId,
            ]);

        if ($response->successful()) {
            $tokenData = $response->json();
            $accessToken = $tokenData['access_token'];
            $expiresIn = $tokenData['expires_in'] - 60; // 1分早く期限切れにする

            // トークンをキャッシュに保存
            Cache::put('zoom_access_token', $accessToken, now()->addSeconds($expiresIn));

            return $accessToken;
        }

        return null;
    }

    public function createMeeting(array $data)
    {
        if (!$this->accessToken) {
            return false;
        }

        $response = Http::withHeaders([
            'Authorization' => 'Bearer ' . $this->accessToken,
            'Content-Type' => 'application/json',
        ])->post($this->apiBaseUrl . 'users/me/meetings', [
            'topic' => $data['title'],
            'type' => 2, // スケジュールされたミーティング
            'start_time' => $data['start'],
            'duration' => 30, // 30分間
            'timezone' => 'Asia/Tokyo',
            'settings' => [
                'host_video' => true,
                'participant_video' => true,
                'waiting_room' => $data['waiting_room'],
                'join_before_host' => false,
                'mute_upon_entry' => true,
                'approval_type' => 0,
                'registration_type' => 1,
                'audio' => 'both',
                'auto_recording' => 'none',
            ]
        ]);

        return $response->successful() ? $response->json() : false;
    }
}
```

### 4. コントローラの実装

予約を作成するためのコントローラメソッドを実装します。`BookingApiController`にZoomミーティングを作成するロジックを追加します。

```php
public function store(Request $request)
{
    // バリデーション
    $validated = $request->validate([
        'title' => 'required|string|max:255',
        'start' => 'required|date_format:Y-m-d H:i:s',
        'end' => 'required|date_format:Y-m-d H:i:s|after:start',
        'waiting_room' => 'nullable|boolean',
        'max_participants' => 'nullable|integer|min:1|max:100',
    ]);

    // Zoom会議の作成
    $zoomMeeting = $this->zoomService->createMeeting([
        'title' => $validated['title'],
        'start' => $validated['start'],
        'waiting_room' => $validated['waiting_room'],
    ]);

    if ($zoomMeeting) {
        // Zoom会議情報を追加
        $validated['zoom_meeting_id'] = $zoomMeeting['id'];
        $validated['zoom_meeting_url'] = $zoomMeeting['join_url'];
        $validated['zoom_meeting_password'] = $zoomMeeting['password'] ?? null;
    }

    // データの保存
    $booking = new Booking();
    $booking->fill($validated);
    $booking->save();

    return response()->json($booking, 201);
}
```

### 5. ビューの修正

カレンダーや予約一覧ページにZoomミーティングの情報を表示するためのビューを修正します。

### 6. テスト

すべての機能が正しく動作するかテストします。Zoom APIとの連携が正常に行われ、ミーティングが作成されることを確認します。

これで、Zoomの予約機能を実装するための手順が完了しました。必要に応じて、エラーハンドリングやユーザーインターフェースの改善を行ってください。

---



---

